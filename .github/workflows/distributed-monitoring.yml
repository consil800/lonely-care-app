name: 3600ì´ˆ ê¸°ë°˜ ì´ˆë‹¨ìœ„ ë¶„ì‚° ëª¨ë‹ˆí„°ë§

on:
  # ë§¤ë¶„ë§ˆë‹¤ ì‹¤í–‰ (GitHub Actions ìµœì†Œ ë‹¨ìœ„)
  schedule:
    - cron: '* * * * *'  # ë§¤ë¶„ ì‹¤í–‰
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      target_second:
        description: 'íƒ€ê²Ÿ ì ˆëŒ€ ì´ˆ (0-3599, ë¹ˆê°’ì´ë©´ í˜„ì¬ ì‹œê°„ ê¸°ì¤€ 60ê°œ ìŠ¬ë¡¯ ì²˜ë¦¬)'
        required: false
        type: string

jobs:
  # ë§¤ë¶„ë§ˆë‹¤ 60ì´ˆë¥¼ ë³‘ë ¬ë¡œ ì²˜ë¦¬ (1ë¶„ = 60ì´ˆ ìŠ¬ë¡¯)
  distributed-monitoring-3600:
    runs-on: ubuntu-latest
    
    strategy:
      # ë³‘ë ¬ë¡œ 60ê°œ ì´ˆë¥¼ ë™ì‹œ ì²˜ë¦¬
      max-parallel: 60
      matrix:
        second_offset: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59]
    
    steps:
      - name: 3600ì´ˆ ë¶„ì‚° ëª¨ë‹ˆí„°ë§ ì‹¤í–‰
        run: |
          # í˜„ì¬ ì ˆëŒ€ ì´ˆ ê³„ì‚° (0~3599)
          if [ "${{ github.event.inputs.target_second }}" != "" ]; then
            ABSOLUTE_SECOND=$(( ${{ github.event.inputs.target_second }} % 3600 ))
          else
            CURRENT_MINUTE=$(date +%M | sed 's/^0*//')
            CURRENT_SECOND=$(date +%S | sed 's/^0*//')
            
            # ë¹ˆ ê°’ ì²˜ë¦¬ (00ë¶„, 00ì´ˆì¸ ê²½ìš°)
            CURRENT_MINUTE=${CURRENT_MINUTE:-0}
            CURRENT_SECOND=${CURRENT_SECOND:-0}
            
            # í˜„ì¬ ë¶„ì˜ 60ê°œ ìŠ¬ë¡¯ ì¤‘ í•˜ë‚˜ë¥¼ ì²˜ë¦¬
            BASE_SECOND=$(( CURRENT_MINUTE * 60 ))
            ABSOLUTE_SECOND=$(( (BASE_SECOND + ${{ matrix.second_offset }}) % 3600 ))
          fi
          
          TARGET_MINUTE=$(( ABSOLUTE_SECOND / 60 ))
          TARGET_SECOND=$(( ABSOLUTE_SECOND % 60 ))
          
          echo "ğŸ• ì²˜ë¦¬í•  ì ˆëŒ€ ì´ˆ: $ABSOLUTE_SECOND (${TARGET_MINUTE}ë¶„ ${TARGET_SECOND}ì´ˆ)"
          
          # Supabase Edge Function í˜¸ì¶œ
          RESPONSE=$(curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/distributed-monitoring" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"target_second\": $ABSOLUTE_SECOND}" \
            --max-time 25 \
            --retry 2 \
            --retry-delay 3 \
            --retry-max-time 30 \
            -s \
            -w "\nHTTP_CODE:%{http_code}" \
            || echo "CURL_FAILED")
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… ì„±ê³µ: $RESPONSE_BODY"
          else
            echo "âŒ ì‹¤íŒ¨ (HTTP $HTTP_CODE): $RESPONSE_BODY"
          fi

      - name: ì‹¤í–‰ ê²°ê³¼ ë¡œê¹…
        run: |
          echo "âš¡ 3600ì´ˆ ë¶„ì‚° ëª¨ë‹ˆí„°ë§ ì™„ë£Œ: $(date)"
          echo "ì²˜ë¦¬ëœ ì ˆëŒ€ ì´ˆ: $ABSOLUTE_SECOND"
          echo "ë§¤íŠ¸ë¦­ìŠ¤ ìŠ¬ë¡¯: ${{ matrix.second_offset }}"

  # ë§¤ì‹œê°„ë§ˆë‹¤ í†µê³„ ë° ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  hourly-performance-check:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 * * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ì‹œê°„ë³„ ì„±ëŠ¥ í†µê³„
        run: |
          echo "ğŸ“Š ì‹œê°„ë³„ 3600ì´ˆ ë¶„ì‚° ëª¨ë‹ˆí„°ë§ í†µê³„: $(date)"
          echo "ğŸš€ ì´ë¡ ì  ì²˜ë¦¬ ëŠ¥ë ¥:"
          echo "  - ë§¤ì´ˆ: ì•½ 2,778ê°œ ì¹œêµ¬ ê´€ê³„ (1ì²œë§Œ Ã· 3600)"
          echo "  - ë§¤ë¶„: ì•½ 166,667ê°œ ì¹œêµ¬ ê´€ê³„ (60ì´ˆ Ã— 2,778)"
          echo "  - ë§¤ì‹œ: 1ì²œë§Œê°œ ì¹œêµ¬ ê´€ê³„ ì™„ì „ ìˆœí™˜"
          
          # í†µê³„ ì¡°íšŒ Edge Function í˜¸ì¶œ (ì˜µì…˜)
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/monitoring-stats" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            --max-time 15 \
            -s \
            || echo "ğŸ“ˆ ìƒì„¸ í†µê³„ëŠ” Supabase ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”"